<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DeepSeek</title>
  <link rel="icon" href="../Public/EcoSmart%20MiniLogo.png" type="image/png">
  <link rel="stylesheet" href="../Deepseek/chatbot.css">
</head>
<body>
<header>
</header>

<div class="principal">
  <div class="columnaIzquierda">
    <!--
    Logo Ecosmart en la columna izquierda
    Tiene que redireccionar a la pagina principal
    -->
    <a href= "../Deepseek/consultas.html">
      <div class="logo">
        <img class= "ecosmart" src="../Public/EcoSmart3.png">
      </div>
    </a>

    <div class="chats">

    </div>

  </div>

  <div class="chatbot" >
    <div class="chat-header">
      <img class="deepseeklogo" src="../Public/deepseeklogo.png"></img>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Escriba su mensaje">
      <button onclick="nuevoChat()">+</button>
    </div>

</div>
</div>

<script>
  let chatActualId = null;

  function getChats() {
    return JSON.parse(localStorage.getItem("chats")) || [];
  }

  function saveChats(chats) {
    localStorage.setItem("chats", JSON.stringify(chats));
  }

  function nuevoChat(nombre = "Chat sin t√≠tulo") {
    const chats = getChats();
    const chatId = `chat-${Date.now()}`;
    const nuevo = { id: chatId, nombre, mensajes: [] };
    chats.push(nuevo);
    saveChats(chats);
    localStorage.setItem("chatId", chatId);
    cargarListaChats();
    seleccionarChat(chatId);
  }


  async function cargarListaChats() {
    const contenedor = document.querySelector('.chats');
    contenedor.innerHTML = '';

    const correo = localStorage.getItem('correo');
    if (!correo) return;

    try {
      const response = await fetch(`http://localhost:5001/api/chat/chats/${correo}`);
      const chats = await response.json();

      chats.forEach(chat => {
        const div = document.createElement('div');
        div.className = 'chat-preview';
        div.innerText = chat.pregunta || 'Chat sin t√≠tulo';

        div.onclick = async () => {
          localStorage.setItem('chatId', chat.chatId); // üîí Guardamos el ID de la conversaci√≥n actual

          try {
            // Pedimos al backend todos los mensajes de este chatId
            const res = await fetch(`http://localhost:5001/api/chat/conversacion/${chat.chatId}`);
            const mensajes = await res.json();

            // Transformamos el array de {pregunta, respuesta} en formato [{user}, {bot}, ...]
            const formateados = mensajes.map(m => [
              { sender: 'user', text: m.pregunta },
              { sender: 'bot', text: m.respuesta }
            ]).flat();

            mostrarMensajesDesdeServidor(formateados);
          } catch (err) {
            console.error('‚ùå Error al cargar conversaci√≥n:', err);
          }
        };


        const eliminar = document.createElement('button');
        eliminar.className = 'eliminar';
        eliminar.innerText = '‚ùå';
        eliminar.onclick = async (e) => {
          e.stopPropagation();
          const confirmacion = confirm('¬øEliminar este chat?');
          if (!confirmacion) return;

          try {
            await fetch(`http://localhost:5001/api/chat/${chat._id}`, {
              method: 'DELETE'
            });
            cargarListaChats();
          } catch (err) {
            console.error('‚ùå Error al eliminar chat:', err);
          }
        };

        div.appendChild(eliminar);
        contenedor.appendChild(div);
      });
    } catch (err) {
      console.error('‚ùå Error al cargar historial:', err);
    }
  }

  function mostrarMensajesDesdeServidor(mensajes) {
    const contenedor = document.getElementById('chatMessages');
    contenedor.innerHTML = '';
    mensajes.forEach(msg => appendMessage(msg.sender, msg.text));
  }


  function seleccionarChat(id) {
    chatActualId = id;
    mostrarMensajes();
  }

  function mostrarMensajes() {
    const chat = getChats().find(c => c.id === chatActualId);
    const contenedor = document.getElementById('chatMessages');
    contenedor.innerHTML = '';
    if (!chat) return;
    chat.mensajes.forEach(msg => appendMessage(msg.sender, msg.text));
  }

  async function eliminarChat(id) {
    try {
      const res = await fetch(`http://localhost:5001/api/chat/${id}`, {
        method: 'DELETE'
      });
      if (!res.ok) throw new Error('Error al eliminar');
      console.log('‚úÖ Chat eliminado');
    } catch (err) {
      console.error('‚ùå Error al eliminar el chat:', err);
    }
  }


  async function askDeepSeek(prompt) {
    const response = await fetch('http://127.0.0.1:5000/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: 'deepseek-coder', prompt: prompt, stream: false })
    });
    const data = await response.json();
    return data.response;
  }

  function appendMessage(sender, text) {
    const chat = document.getElementById('chatMessages');
    const msg = document.createElement('div');
    msg.className = sender === 'user' ? 'msg user' : 'msg bot';
    msg.textContent = text;
    chat.appendChild(msg);
  }

  async function sendMessage() {
    const input = document.getElementById('chatInput');
    const userText = input.value.trim();
    if (userText === '') return;

    if (!chatActualId) {
      const nombre = userText.length > 30 ? userText.slice(0, 30) + '...' : userText;
      await nuevoChat(nombre); // ‚è≥ Esperamos a que se cree el nuevo chat
      chatActualId = localStorage.getItem('chatId'); // üÜó Ahora s√≠ lo actualizamos
    }

    appendMessage('user', userText);
    input.value = '';

    const chatBox = document.getElementById('chatMessages');
    const loadingBubble = document.createElement('div');
    loadingBubble.className = 'msg bot';
    loadingBubble.innerHTML = `
    <span class="typing-dots">
      <span></span><span></span><span></span>
    </span>
  `;
    chatBox.appendChild(loadingBubble);

    const botResponse = await askDeepSeek(userText);

    const chats = getChats();
    const chat = chats.find(c => c.id === chatActualId);

    if (!chat.nombre || chat.nombre === 'Chat sin t√≠tulo') {
      chat.nombre = userText.length > 30 ? userText.slice(0, 30) + '...' : userText;
    }

    chat.mensajes.push({ sender: 'user', text: userText });
    chat.mensajes.push({ sender: 'bot', text: botResponse });
    saveChats(chats);
    cargarListaChats();

    loadingBubble.innerHTML = botResponse;

    const correo = localStorage.getItem('correo');
    const chatId = localStorage.getItem('chatId'); // ahora debe estar bien definido ‚úÖ

    if (correo && chatId) {
      fetch('http://localhost:5001/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          correo: correo,
          chatId: chatId,
          pregunta: userText,
          respuesta: botResponse
        })
      })
              .then(res => res.json())
              .then(data => console.log('‚úÖ Chat guardado en MongoDB:', data))
              .catch(err => console.error('‚ùå Error al guardar el chat:', err));
    } else {
      console.warn('‚ö†Ô∏è No se encontr√≥ correo o chatId en localStorage');
    }
  }



  window.onload = () => {
    cargarListaChats();

    const input = document.getElementById('chatInput');
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });
  };
</script>

</body>
</html>
