<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DeepSeek</title>
  <link rel="icon" href="../Public/EcoSmart%20MiniLogo.png" type="image/png">
  <link rel="stylesheet" href="chatbot.css">
</head>
<body>
<header>
</header>

<div class="principal">
  <div class="columnaIzquierda">
    <!--
    Logo Ecosmart en la columna izquierda
    Tiene que redireccionar a la pagina principal
    -->
    <a href= "../Principales/Pagina-Principal.html">
      <div class="logo">
        <img class= "ecosmart" src="../Public/EcoSmart3.png">
      </div>
    </a>

    <div class="chats">

    </div>

  </div>

  <div class="chatbot">
    <!-- Header con logo -->
    <div class="chat-header">
      <img class="deepseeklogo" src="../Public/deepseeklogo.png" alt="DeepSeek Logo" />
    </div>

    <!-- Preguntas r√°pidas para que el usuario seleccione -->
    <div class="fastQuestions">
      <div class="faq-item" onclick="sendMessageAndHide(this)">
        <h3 class="Question">¬øQu√© factores afectan el rendimiento de un cultivo?</h3>
      </div>
      <div class="faq-item" onclick="sendMessageAndHide(this)">
        <h3 class="Question">¬øQu√© enfermedades y plagas pueden afectar los cultivos?</h3>
      </div>
      <div class="faq-item" onclick="sendMessageAndHide(this)">
        <h3 class="Question">¬øQu√© tan importante es la rotaci√≥n de cultivos?</h3>
      </div>
      <div class="faq-item" onclick="sendMessageAndHide(this)">
        <h3 class="Question">¬øQu√© tipo de suelo es el m√°s adecuado para cultivar?</h3>
      </div>
    </div>

    <!-- Contenedor de mensajes -->
    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." />
      <button onclick="nuevoChat()" title="Nuevo Chat">
        <img class="newChat" src="../Public/nuevoChat.png" alt="Nuevo Chat" />
      </button>
    </div>
  </div>

</div>



<script>
  let chatActualId = null;

  function vanishSquare(){

  }

  function getChats() {
    return JSON.parse(localStorage.getItem("chats")) || [];
  }

  function saveChats(chats) {
    localStorage.setItem("chats", JSON.stringify(chats));
  }

  function nuevoChat(nombre = "Chat sin t√≠tulo") {
    const chats = getChats();
    const chatId = `chat-${Date.now()}`;
    const nuevo = { id: chatId, chatId, nombre, mensajes: [] };
    chats.push(nuevo);
    saveChats(chats);
    localStorage.setItem("chatId", chatId);
    cargarListaChats();
    seleccionarChat(chatId);

    const preguntas = document.querySelector('.fastQuestions');
    if (preguntas) {
      preguntas.style.display = '';
    }

    return chatId;
  }

  async function cargarListaChats() {
    const contenedor = document.querySelector('.chats');
    contenedor.innerHTML = '';

    const correo = localStorage.getItem('correo');
    if (!correo) return;

    try {
      const response = await fetch(`http://localhost:5001/api/chat/chats/${correo}`);
      const chats = await response.json();

      chats.forEach(chat => {
        const div = document.createElement('div');
        div.className = 'chat-preview';
        div.innerText = chat.pregunta || 'Chat sin t√≠tulo';

        div.onclick = async () => {
          localStorage.setItem('chatId', chat.chatId);
          chatActualId = chat.chatId;

          // Ocultar preguntas r√°pidas al seleccionar un chat previo
          const preguntas = document.querySelector('.fastQuestions');
          if (preguntas) {
            preguntas.style.display = 'none';
          }

          try {
            const res = await fetch(`http://localhost:5001/api/chat/conversacion/${chat.chatId}`);
            const mensajes = await res.json();

            const formateados = mensajes.map(m => [
              { sender: 'user', text: m.pregunta },
              { sender: 'bot', text: m.respuesta }
            ]).flat();

            mostrarMensajesDesdeServidor(formateados);
          } catch (err) {
            console.error('‚ùå Error al cargar conversaci√≥n:', err);
          }
        };

        const eliminar = document.createElement('button');
        eliminar.className = 'eliminar';
        eliminar.innerText = '‚ùå';
        eliminar.onclick = async (e) => {
          e.stopPropagation();
          const confirmacion = confirm('¬øEliminar este chat?');
          if (!confirmacion) return;

          try {
            await fetch(`http://localhost:5001/api/chat/${chat.chatId}`, {
              method: 'DELETE'
            });
            if (localStorage.getItem('chatId') === chat.chatId) {
              localStorage.removeItem('chatId');
              chatActualId = null;
            }
            cargarListaChats();
          } catch (err) {
            console.error('‚ùå Error al eliminar chat:', err);
          }
        };

        div.appendChild(eliminar);
        contenedor.appendChild(div);
      });
    } catch (err) {
      console.error('‚ùå Error al cargar historial:', err);
    }
  }

  function mostrarMensajesDesdeServidor(mensajes) {
    const contenedor = document.getElementById('chatMessages');
    contenedor.innerHTML = '';
    mensajes.forEach(msg => appendMessage(msg.sender, msg.text));
  }

  function seleccionarChat(id) {
    chatActualId = id;
    mostrarMensajes();
  }

  function mostrarMensajes() {
    const chat = getChats().find(c => c.id === chatActualId);
    const contenedor = document.getElementById('chatMessages');
    contenedor.innerHTML = '';
    if (!chat) return;
    chat.mensajes.forEach(msg => appendMessage(msg.sender, msg.text));
  }

  function appendMessage(sender, text) {
    const chat = document.getElementById('chatMessages');
    const msg = document.createElement('div');
    msg.className = sender === 'user' ? 'msg user' : 'msg bot';
    msg.textContent = text;
    chat.appendChild(msg);
  }

  async function eliminarChat(id) {
    try {
      const res = await fetch(`http://localhost:5001/api/chat/${id}`, {
        method: 'DELETE'
      });
      if (!res.ok) throw new Error('Error al eliminar');
      console.log('‚úÖ Chat eliminado');
    } catch (err) {
      console.error('‚ùå Error al eliminar el chat:', err);
    }
  }

  const temasPermitidos = [
    'planta', 'cultivo', 'suelo', 'riego', 'fertilizante', 'pesticida',
    'plaga', 'enfermedad', 'rotaci√≥n', 'compost', 'abonado', 'invernadero',
    'hortaliza', 'germinaci√≥n', 'ra√≠ces', 'ecolog√≠a', 'biodegradable', 'sustrato',
    'insecto', 'bicho', 'hojas', 'flores', 'frutas', 'semilla', 'polinizaci√≥n',
    'fungicida', 'micorriza', 'poda', 'abono', 'cosecha', 'semillero',
    'alm√°cigo', 'biotecnolog√≠a', 'control biol√≥gico', 'organismo beneficioso',
    'plaguicida', 'microorganismo', 'fertilizaci√≥n foliar', 'mulching',
    'enraizamiento', 'permacultura', 'agroecolog√≠a', 'cultivo hidrop√≥nico',
    'cultivo org√°nico', 'biodiversidad', 'microclima', 'bioma',
    'nutrientes', 'toxinas', 'abono verde', 'carbono org√°nico', 'ph suelo',
    'materia org√°nica', 'polen', 'agua', 'drenaje', 'sembrar', 'labranza',
    'capullo', 'p√©talo', 'estambre', 'estigma', 'carpelo', 'corola', 'inflorescencia',
    'floraci√≥n', 'polen', 'nectar', 'jardiner√≠a', 'aroma', 'perfume', 'floricultura',
    'rosal', 'jazm√≠n', 'margarita', 'orqu√≠dea', 'clavel', 'tulip√°n', 'geranio',
    'hibisco', 'lavanda', 'alegr√≠a', 'petunia', 'dalia', 'azucena', 'girasol',
    'crisantemo', 'an√©mona', 'azalea', 'gardenia', 'violeta', 'begonia'
  ];



  function esPreguntaValida(texto) {
    const lower = texto.toLowerCase();
    return temasPermitidos.some(palabra => lower.includes(palabra));
  }

  async function sendMessage(questionText = '') {
    const input = document.getElementById('chatInput');
    const userText = questionText || input.value.trim();
    if (userText === '') return;

    const preguntas = document.querySelector('.fastQuestions');
    if (preguntas) {
      preguntas.style.display = 'none';
    }

    if (!esPreguntaValida(userText)) {
      appendMessage('user', userText);
      appendMessage('bot', 'üå± Lo siento, solo puedo responder preguntas relacionadas con plantas, agricultura o ecolog√≠a.');
      input.value = '';
      return;
    }

    if (!chatActualId) {
      const nombre = userText.length > 30 ? userText.slice(0, 30) + '...' : userText;
      chatActualId = await nuevoChat(nombre);
    }

    appendMessage('user', userText);
    if (!questionText) input.value = '';

    const chatBox = document.getElementById('chatMessages');

    // Crear burbuja "escribiendo..."
    const loadingBubble = document.createElement('div');
    loadingBubble.className = 'msg bot';
    loadingBubble.id = 'loading-bubble';
    loadingBubble.innerHTML = `
<div class="typing-container">
  <div class="typing-dots"><span></span><span></span><span></span></div>
</div>`;

    chatBox.appendChild(loadingBubble);
    chatBox.scrollTop = chatBox.scrollHeight;

    const chats = getChats();
    const chat = chats.find(c => c.id === chatActualId);

    let historialTexto = '';
    chat.mensajes.forEach(msg => {
      historialTexto += `${msg.text}\n`;
    });
    historialTexto += `${userText}\n`;

    try {
      const botResponse = await askDeepSeek(historialTexto);

      if (!chat.nombre || chat.nombre === 'Chat sin t√≠tulo') {
        chat.nombre = userText.length > 30 ? userText.slice(0, 30) + '...' : userText;
      }

      chat.mensajes.push({ sender: 'user', text: userText });
      chat.mensajes.push({ sender: 'bot', text: botResponse });
      saveChats(chats);
      cargarListaChats();

      // Reemplaza animaci√≥n con respuesta
      loadingBubble.innerHTML = botResponse;
    } catch (err) {
      console.error('‚ùå Error al obtener respuesta:', err);
      if (loadingBubble) loadingBubble.remove();
      appendMessage('bot', '‚ö†Ô∏è Hubo un problema al generar la respuesta. Intenta de nuevo.');
    }

    const correo = localStorage.getItem('correo');
    const chatId = localStorage.getItem('chatId');

    if (correo && chatId) {
      fetch('http://localhost:5001/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          correo: correo,
          chatId: chatId,
          pregunta: userText,
          respuesta: loadingBubble.innerHTML || ''
        })
      })
              .then(res => res.json())
              .then(data => console.log('‚úÖ Chat guardado en MongoDB:', data))
              .catch(err => console.error('‚ùå Error al guardar el chat:', err));
    } else {
      console.warn('‚ö†Ô∏è No se encontr√≥ correo o chatId en localStorage');
    }
  }

  async function sendMessageAndHide(element) {
    const mensaje = element.innerText;
    await sendMessage(mensaje);
    const preguntas = document.querySelector('.fastQuestions');
    if (preguntas) {
      preguntas.style.display = 'none';
    }
  }

  async function askDeepSeek(historial) {
    const systemPrompt = `Eres un asistente experto en bot√°nica, agricultura y ecolog√≠a. Solo debes responder preguntas sobre plantas, cultivos, suelos, fertilizantes, plagas, enfermedades vegetales, riego, t√©cnicas de cultivo o temas ecol√≥gicos relacionados. Si el usuario pregunta algo fuera de esos temas, responde amablemente que solo puedes hablar sobre temas bot√°nicos. No hagas roleplay. S√© conciso y claro.`;

    const prompt = `${systemPrompt}\n\n${historial}\nAsistente:`;

    const response = await fetch('http://127.0.0.1:5000/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'tinyllama',
        prompt: prompt,
        stream: false
      })
    });

    const data = await response.json();
    return data.response;
  }

  window.onload = () => {
    cargarListaChats();

    const input = document.getElementById('chatInput');
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });
  };
</script>




</body>
</html>