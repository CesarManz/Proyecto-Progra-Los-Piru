<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mis Alertas Configuradas</title>
  <link rel="stylesheet" href="../Principales/Estilo-prin.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3), #c1d36b), url("../Public/Fondo.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    main {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    main h2 {
      text-align: center;
      color: #1D2A10;
      margin-bottom: 1.5rem;
      font-size: 26px;
    }

    #tabla-alertas {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .alerta-item {
      background: #fdfdfd;
      border-left: 6px solid #CD8A39;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 20px;
    }

    .alerta-info {
      flex: 1;
      font-size: 14px;
      color: #1D2A10;
    }

    .alerta-info p {
      margin: 4px 0;
    }

    .alerta-acciones {
      display: flex;
      gap: 10px;
    }

    .alerta-acciones button {
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .alerta-acciones button:hover {
      opacity: 0.85;
    }

    .editar {
      background-color: #A9B147;
      color: white;
    }

    .eliminar {
      background-color: #F06D6D;
      color: white;
    }

    .sin-alertas {
      text-align: center;
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo" onclick="window.location.href='../Principales/Pagina-Principal.html'">
      <img src="../Public/EcoSmart2.png" alt="Logo" />
    </div>
    <nav id="menu">
      <input class="busqueda" type="search" placeholder="Buscar">
    </nav>
    <div class="icono-notificacion" onclick="toggleNotificaciones()" style="position: relative; cursor: pointer;">
      <img src="../Public/campana.png" alt="Notificaciones" style="width: 28px; height: 28px;">
      <span id="alerta-punto" style="position:absolute;top:0;right:0;width:10px;height:10px;background:red;border-radius:50%;border:2px solid white;display:none;"></span>
    </div>
    <div class="Fondo-fo-perfil" onclick="toggleMenu(event)">
      <img class="fo-perfil" src="../Public/user.png" alt="Foto de perfil">
      <div id="menuPerfil" class="menu-perfil">
        <a href="../Perfil/Perfil.html">Perfil</a>
        <a href="#" onclick="logout()">Cerrar sesi√≥n</a>
      </div>
    </div>
  </header>
  <div id="notificaciones-box"></div>

  <main>
    <div style="text-align: right; margin-bottom: 20px;">
      <a href="alertas.html" style="text-decoration: none; background: #CD8A39; padding: 10px 18px; border-radius: 8px; color: white; font-weight: bold;">+ Crear nueva alerta</a>
    </div>

    <h2>Mis Alertas Configuradas</h2>
    <div id="tabla-alertas">
      <p class="sin-alertas">Cargando alertas...</p>
    </div>
  </main>

  <script src="../notificacion.js"></script>
  <script>
    const correo = localStorage.getItem("correo");
    let alertasSimuladas = [];

    function cargarAlertas() {
      const tabla = document.getElementById("tabla-alertas");
      tabla.innerHTML = '<p class="sin-alertas">Cargando...</p>';

      fetch("http://localhost:5001/api/alertas")
        .then(res => res.json())
        .then(data => {
          const filtradas = data.filter(a => a.correo === correo);
          tabla.innerHTML = "";

          if (!filtradas.length) {
            tabla.innerHTML = '<p class="sin-alertas">No hay alertas configuradas.</p>';
            return;
          }

          alertasSimuladas = filtradas;

          filtradas.forEach(alerta => {
            const card = document.createElement("div");
            card.className = "alerta-item";
            card.innerHTML = `
              <div class="alerta-info">
                <p><strong>Parcela:</strong> ${alerta.parcela?.nombre || alerta.parcela}</p>
                <p><strong>Sensor:</strong> ${alerta.sensor}</p>
                <p><strong>Umbral m√≠nimo:</strong> ${alerta.umbralMinimo}</p>
                <p><strong>Descripci√≥n m√≠nima:</strong> ${alerta.descripcionMinimo}</p>
                <p><strong>Umbral m√°ximo:</strong> ${alerta.umbralMaximo}</p>
                <p><strong>Descripci√≥n m√°xima:</strong> ${alerta.descripcionMaximo}</p>
                <p><strong>Correo:</strong> ${alerta.correo}</p>
              </div>
              <div class="alerta-acciones">
                <button class="editar" onclick="editarAlerta('${alerta._id}')">‚úèÔ∏è</button>
                <button class="eliminar" onclick="eliminarAlerta('${alerta._id}')">üóëÔ∏è</button>
              </div>
            `;
            tabla.appendChild(card);
          });
        });
    }

    function editarAlerta(id) {
      alert("Funcionalidad de edici√≥n en desarrollo para la alerta ID: " + id);
    }

    function eliminarAlerta(id) {
      if (!confirm("¬øEst√°s seguro de eliminar esta alerta?")) return;
      fetch(`http://localhost:5001/api/alertas/eliminar/${id}`, { method: "DELETE" })
        .then(() => cargarAlertas());
    }

    function toggleMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('menuPerfil');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function logout() {
      localStorage.clear();
      window.location.href = '../Registro-Login/Login.html';
    }

    const trabajo = localStorage.getItem('trabajo');
    const menu = document.getElementById('menu');
    if (!trabajo || !correo) window.location.href = '../Registro-Login/Login.html';

    const linksPorRol = {
      tecnico: [
        { texto: "P√°gina principal", href: "../Principales/Pagina-Principal.html" },
        { texto: "Parcelas", href: "../parcelas/listar-parcelas.html" },
        { texto: "Administrar usuarios", href: "../Administrar-Usuarios/Administrar-usuarios.html" },
        { texto: "Preguntas", href: "../Deepseek/consultas.html" },
      ],
      agronomo: [
        { texto: "P√°gina principal", href: "../Principales/Pagina-Principal.html" },
        { texto: "Parcelas", href: "../parcelas/listar-parcelas.html" },
        { texto: "Preguntas", href: "../Deepseek/consultas.html" },
        { texto: "Inventario", href: "../Inventario/Inventario.html" },
        { texto: "Asignar tareas", href: "../Tareas/Asignar-tareas.html" }
      ],
      agricultor: [
        { texto: "P√°gina principal", href: "../Principales/Pagina-Principal.html" },
        { texto: "Parcelas", href: "../parcelas/listar-parcelas.html" },
        { texto: "Preguntas", href: "../Deepseek/consultas.html" }
      ]
    };

    const enlaces = linksPorRol[trabajo];
    if (enlaces) enlaces.forEach(link => {
      const a = document.createElement('a');
      a.href = link.href;
      a.textContent = link.texto;
      menu.insertBefore(a, menu.querySelector('.busqueda'));
    });

    document.addEventListener("DOMContentLoaded", cargarAlertas);
  </script>
</body>
</html>
