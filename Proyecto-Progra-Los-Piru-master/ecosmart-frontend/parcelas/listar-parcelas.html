<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Parcelas Registradas</title>
  <link rel="stylesheet" href="../Estilo-prin.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3), #c1d36b), url("../public/Fondo.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      font-family: 'Segoe UI', sans-serif;
      color: #1D2A10;
    }

    header {
      background-color: #1D2A10;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #CD8A39;
      height: 70px;
    }

    .logo img {
      width: 150px;
      height: auto;
    }

    nav a {
      color: #CD8A39;
      text-decoration: none;
      font-weight: bold;
      margin: 0 10px;
    }

    nav a:hover {
      text-decoration: underline;
    }

    .busqueda {
      background-color: #CD8A39;
      padding: 5px;
      border: none;
      border-radius: 4px;
    }

    main {
      background-color: rgba(205, 138, 57, 0.9);
      border-radius: 16px;
      padding: 24px;
      max-width: 1200px;
      margin: 2rem auto;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .tarjeta {
      background-color: #fff;
      border: 2px solid #1D2A10;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      color: #1D2A10;
    }

    .mapa {
      height: 200px;
      margin: 10px 0;
      border-radius: 10px;
    }

    .clima-widget {
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px 15px;
      margin: 15px 0;
    }

    .acciones {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .acciones button {
      background-color: #1D2A10;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .acciones button:last-child {
      background-color: #b22222;
    }

    .top-buttons {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 20px;
    }

    .top-buttons a {
      background-color: #1D2A10;
      color: white;
      padding: 10px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
<header>
  <div class="logo">
    <img src="../public/EcoSmart2.png" />
  </div>
  <nav>
    <a href="../index.html">Inicio</a>
    <a href="listar-parcelas.html">Parcelas</a>
    <a href="#">Inventario</a>
    <a href="../consultas.html">Preguntas</a>
    <input type="search" class="busqueda" placeholder="Buscar" />
  </nav>
</header>

<main>
  <div class="top-buttons">
    <a href="crear-parcela.html">+ Crear nueva parcela</a>
  </div>
  <h2>Parcelas registradas</h2>
  <div id="contenedorParcelas"></div>
</main>

<script>
async function cargarParcelas() {
  const res = await fetch("http://localhost:5001/api/parcelas");
  const parcelas = await res.json();
  const contenedor = document.getElementById("contenedorParcelas");
  contenedor.innerHTML = "";

  for (const p of parcelas) {
    const clima = await obtenerClima(p.coordenadas.lat, p.coordenadas.lon);
    const idMapa = "map-" + p._id;
    const div = document.createElement("div");
    div.className = "tarjeta";
    div.innerHTML =
      '<h3>üåø ' + p.nombre + '</h3>' +
      '<p><strong>üìç Coordenadas:</strong> ' + p.coordenadas.lat + ', ' + p.coordenadas.lon + '</p>' +
      '<div id="' + idMapa + '" class="mapa"></div>' +
      '<div class="clima-widget">' +
        '<p>‚òÅÔ∏è Clima: ' + clima.descripcion + ' - ' + clima.temperatura + '¬∞C</p>' +
        '<p>üíß Humedad: ' + clima.humedad + '% | üå¨ Viento: ' + clima.viento + ' km/h</p>' +
      '</div>' +
      '<p><strong>üìä √öltimas lecturas:</strong></p>' +
      '<ul id="lecturas_' + p._id + '"></ul>' +
      '<div class="acciones">' +
        '<button onclick="verHistorial(\'' + p.nombre + '\')">üìà Ver historial</button>' +
        '<button onclick="eliminarParcela(\'' + p._id + '\')">üóë Eliminar</button>' +
      '</div>';
    contenedor.appendChild(div);

    const mapa = L.map(idMapa).setView([p.coordenadas.lat, p.coordenadas.lon], 13);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(mapa);
    L.marker([p.coordenadas.lat, p.coordenadas.lon]).addTo(mapa);

    cargarLecturas(p._id);
  }
}

async function obtenerClima(lat, lon) {
  try {
    const res = await fetch("http://localhost:5001/api/climaActual?lat=" + lat + "&lon=" + lon);
    return await res.json();
  } catch {
    return { descripcion: "N/D", temperatura: "?", humedad: "?", viento: "?" };
  }
}

function verHistorial(nombre) {
  window.location.href = "historial-parcela.html?nombre=" + encodeURIComponent(nombre);
}

async function eliminarParcela(id) {
  if (!confirm("¬øEliminar esta parcela?")) return;
  const res = await fetch("http://localhost:5001/api/parcelas/" + id, { method: "DELETE" });
  if (res.ok) {
    alert("‚úÖ Parcela eliminada");
    cargarParcelas();
  } else {
    alert("‚ùå No se pudo eliminar");
  }
}

async function cargarLecturas(parcelaId) {
  try {
    const res = await fetch("http://localhost:5001/api/lecturas/" + parcelaId);
    const datos = await res.json();
    const ul = document.getElementById("lecturas_" + parcelaId);
    ul.innerHTML = "";
    datos.slice(0, 4).forEach(lectura => {
      const li = document.createElement("li");
      li.textContent = lectura.tipo + ": " + lectura.valor + " (" + new Date(lectura.fecha).toLocaleTimeString() + ")";
      ul.appendChild(li);
    });
  } catch (err) {
    console.error("Error al cargar lecturas:", err);
  }
}

window.onload = cargarParcelas;
</script>
</body>
</html>
